!function(t){"use strict";function e(t){return new d(t)}function n(t){return!!t}function r(t){return t.isContext?t:new v(t)}function i(){if(p.logLevel<=k.debug){var t;(t=console).log.apply(t,arguments)}}function o(){if(p.logLevel<=k.info){var t;(t=console).log.apply(t,arguments)}}function u(){if(p.logLevel<=k.error){var t;(t=console).log.apply(t,arguments)}}var s=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},f=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];s(this,t),this.contexts=e}return a(t,[{key:"has",value:function(t,e){return this.contexts.some(function(n){return n.has(t,e)})}},{key:"get",value:function(t,e){for(var n=0;n<this.contexts.length;n++){var r=this.contexts[n],i=r.get(t,e);if(i)return i}}}]),t}(),l=Symbol("DefaultContext"),h=function(){function t(e){var n=e.injector,r=e.config,i=void 0===r?null:r;s(this,t),this.injector=n,this.config=i}return a(t,[{key:"setConfig",value:function(t){this.config=t}},{key:"register",value:function(t,e){return this.injector.register(t,e)}},{key:"load",value:function(t){for(var e,n=this.getDefaultContext(),r=this.getConfiguredContext(t),i=arguments.length,o=Array(i>1?i-1:0),u=1;u<i;u++)o[u-1]=arguments[u];return(e=this.injector).load.apply(e,[t,n,r].concat(o))}},{key:"getDefaultContext",value:function(){var t=this.config[l];return this.getContext(t)}},{key:"getConfiguredContext",value:function(t){var e=this.config[t];return this.getContext(e)}},{key:"getContext",value:function(t){return t instanceof Function?t():t||void 0}}]),t}(),v=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,t),this.values=e,this.isContext=!0}return a(t,[{key:"has",value:function(t){return!!this.values[t]}},{key:"get",value:function(t){return this.values[t]}}]),t}(),g=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];s(this,t),this.contexts=e}return a(t,[{key:"add",value:function(){var t;(t=this.contexts).push.apply(t,arguments)}},{key:"getContext",value:function(t){for(var e=0;e<this.contexts.length;e++){var n=this.contexts[e];if(n.has(t,this))return n}}},{key:"getModule",value:function(t){for(var e=0;e<this.contexts.length;e++){var n=this.contexts[e],r=n.get(t,this);if(r)return{instance:r,context:n,key:t}}return{}}}]),t}(),y=function(){function t(){s(this,t),this.listeners=[]}return a(t,[{key:"on",value:function(t){var e=this;return this.listeners.push(t),function(){return e.off(t)}}},{key:"off",value:function(t){for(var e=void 0;-1!==(e=this.listeners.indexOf(t));)this.listeners.splice(e,1)}},{key:"dispatch",value:function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];this.listeners.forEach(function(t){return t.apply(void 0,e)})}}]),t}(),d=function t(e){s(this,t),this.cls=e,this.instance=null},x=Object.freeze({Module:d,module:e}),C=function(){function t(e){var n=e.registry,r=e.cache,i=e.construct,o=e.defaultContext;s(this,t),this.registry=n,this.cache=r,this.construct=i,this.defaultContext=o}return a(t,[{key:"getAvailableContexts",value:function(t){var e=new g,i=t.filter(n).map(r).reverse();return e.add.apply(e,c(i).concat([this.defaultContext])),e}},{key:"register",value:function(t,e){return this.registry.register(t,e)}},{key:"load",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];var i=this.getAvailableContexts(n);return this.cache.get(t,i)||this.construct.get(t,i)}}]),t}(),k={debug:1,info:2,error:3},p={logLevel:k.info},b=Object.freeze({debug:i,info:o,error:u,LOGLEVEL:k,preferences:p}),m=function(){function t(){s(this,t),this.scopes=new WeakMap}return a(t,[{key:"clear",value:function(){this.scopes=new WeakMap}},{key:"add",value:function(t,e){this.scopes.set(t,e)}},{key:"get",value:function(t){return this.scopes.get(t)}}]),t}(),w=new m,A=function(){function t(){s(this,t),this.values={}}return a(t,[{key:"add",value:function(t,e){this.values[t]=this.values[t]||[],-1===this.values[t].indexOf(e)&&(i("Add to cache",t.toString()),this.values[t].push(e))}},{key:"has",value:function(t,e){return!!this.__get(t,e)}},{key:"get",value:function(t,e){var n=this.__get(t,e);if(n)return i("Loaded cached instance of",t.toString()),n}},{key:"__get",value:function(t,e){var n=this,r=this.values,i=r[t];if(i)return i.find(function(t){var r=w.get(t).usedContexts;return n.canUseScope(r,e)})}},{key:"canUseScope",value:function(t,e){return t.every(function(t){var n=t.context,r=t.key;return n===e.getContext(r)})}}]),t}(),L=function(){function t(e){var n=e.registry,r=e.args,i=e.cache;s(this,t),this.args=r,this.registry=n,this.cache=i}return a(t,[{key:"has",value:function(t){return!!this.registry.get(t)}},{key:"get",value:function(t,e){var n={},r=[],o={id:n,availableContexts:e,usedContexts:r},u=this.registry.get(t);if(u){var s=new u(this.args.get(o));return w.add(s,o),i("Created new instance of",t.toString()),this.cache.add(t,s),s}}}]),t}(),j=function(){function t(){s(this,t)}return a(t,[{key:"get",value:function(t){var e=this;return new Proxy({},{get:function(n,r){return e.getInstance(r,t)}})}},{key:"getInstance",value:function(t,e){var n=e.availableContexts.getModule(t),r=n.context,i=n.instance;if(!i)throw new Error("Not found");var o=w.get(i);if(o){if(o.availableContexts===e.availableContexts){var u;(u=e.usedContexts).push.apply(u,c(o.usedContexts))}}return e.usedContexts.push({context:r,key:t}),i}}]),t}(),S=function(){function t(){s(this,t),this.registered=new y,this.modules={}}return a(t,[{key:"register",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Symbol(t.name);return this.modules[e]=t,this.registered.dispatch(e),e}},{key:"get",value:function(t){return this.modules[t]}}]),t}();t.CompositeContext=f,t.ConfigurableInjector=h,t.Context=v,t.ContextList=g,t.DefaultContext=l,t.EventSource=y,t.Injector=C,t.Log=b,t.Configuration=x,t.ModuleCache=A,t.ModuleConstructor=L,t.ProxyArguments=j,t.Registry=S}(this.modulinDi=this.modulinDi||{});
